\<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PaigonAi ‚Äî Account</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!-- üîù Navigation Bar -->
  <header class="navbar">
    <a href="index.html" class="logo">PaigonAi</a>

    <nav>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="#">Games</a></li>
        <li><a href="#">Leaderboard</a></li>
      </ul>
    </nav>

    <div class="user-menu" id="account-user-menu">
      <button class="user-button" id="user-button" type="button">
        <span id="nav-username">Account</span>
        <span class="chev">‚ñæ</span>
      </button>

      <div class="dropdown is-hidden" id="user-dropdown">
        <button class="dropdown-item" id="go-home" type="button">Home</button>
        <button class="dropdown-item" id="logout" type="button">Logout</button>
      </div>
    </div>
  </header>

  <!-- üß† Account Content -->
  <main class="account-page">
    <div class="account-wrap">
      <h1 class="account-title">Account</h1>
      <p class="account-sub">Manage your profile and sign-in methods.</p>

      <section class="card">
        <div class="card-head">
          <div>
            <h2 class="card-title">Profile</h2>
            <p class="card-sub">This info comes from your Firebase account + Firestore user doc.</p>
          </div>
          <span class="pill" id="auth-pill">Checking‚Ä¶</span>
        </div>

        <div class="kv">
          <div class="kv-row">
            <div class="kv-k">Username</div>
            <div class="kv-v" id="profile-username">‚Äî</div>
          </div>
          <div class="kv-row">
            <div class="kv-k">Email</div>
            <div class="kv-v" id="profile-email">‚Äî</div>
          </div>
          <div class="kv-row">
            <div class="kv-k">Phone</div>
            <div class="kv-v" id="profile-phone">‚Äî</div>
          </div>
          <div class="kv-row">
            <div class="kv-k">Provider</div>
            <div class="kv-v" id="profile-provider">‚Äî</div>
          </div>
          <div class="kv-row">
            <div class="kv-k">User ID</div>
            <div class="kv-v mono" id="profile-uid">‚Äî</div>
          </div>
          <div class="kv-row">
            <div class="kv-k">Created</div>
            <div class="kv-v" id="profile-created">‚Äî</div>
          </div>
        </div>

        <div class="card-actions">
          <a class="btn btn-ghost" href="index.html">‚Üê Back to Home</a>
        </div>
      </section>

      <section class="card">
        <h2 class="card-title">Settings (coming soon)</h2>
        <p class="card-sub">
          Next we can add: change username, wallet, game history, account deletion, notifications.
        </p>

        <div class="coming-grid">
          <div class="coming-item">Wallet / Balance</div>
          <div class="coming-item">Match History</div>
          <div class="coming-item">Username Change</div>
          <div class="coming-item">Account Deletion</div>
        </div>
      </section>
    </div>
  </main>

  <!-- ‚úÖ Toasts -->
  <div id="toast-root" class="toast-root" aria-live="polite" aria-atomic="true"></div>

  <script type="module">
    // ---------- Toast helper ----------
    function showToast(type, title, msg, ms = 2200) {
      const root = document.getElementById("toast-root");
      if (!root) return;

      const el = document.createElement("div");
      el.className = `toast ${type}`;
      el.innerHTML = `<div class="title">${title}</div><div class="msg">${msg}</div>`;

      root.appendChild(el);
      requestAnimationFrame(() => el.classList.add("show"));

      setTimeout(() => {
        el.classList.remove("show");
        setTimeout(() => el.remove(), 250);
      }, ms);
    }

    // ---------- Firebase Imports ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    // ---------- Config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAIEYryVjB1gX2bzXWERNI0udfjHXuXwzc",
      authDomain: "paigonco.firebaseapp.com",
      projectId: "paigonco",
      storageBucket: "paigonco.appspot.com",
      messagingSenderId: "879434208536",
      appId: "1:879434208536:web:5ff633fc0534c3f1d73a6d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- Elements ----------
    const authPill = document.getElementById("auth-pill");

    const navUsername = document.getElementById("nav-username");
    const userBtn = document.getElementById("user-button");
    const dropdown = document.getElementById("user-dropdown");
    const logoutBtn = document.getElementById("logout");
    const goHomeBtn = document.getElementById("go-home");

    const elUsername = document.getElementById("profile-username");
    const elEmail = document.getElementById("profile-email");
    const elPhone = document.getElementById("profile-phone");
    const elProvider = document.getElementById("profile-provider");
    const elUid = document.getElementById("profile-uid");
    const elCreated = document.getElementById("profile-created");

    // ---------- User menu ----------
    userBtn?.addEventListener("click", () => dropdown?.classList.toggle("is-hidden"));

    document.addEventListener("click", (e) => {
      const wrap = document.getElementById("account-user-menu");
      if (!wrap) return;
      if (!wrap.contains(e.target)) dropdown?.classList.add("is-hidden");
    });

    goHomeBtn?.addEventListener("click", () => (window.location.href = "index.html"));

    logoutBtn?.addEventListener("click", async () => {
      try {
        await signOut(auth);
        dropdown?.classList.add("is-hidden");
        showToast("success", "Logged out", "See you next time.");
        setTimeout(() => (window.location.href = "index.html"), 250);
      } catch (err) {
        showToast("error", "Logout failed", err.message);
      }
    });

    // ---------- Helpers ----------
    function formatDateAny(x) {
      try {
        // Firestore Timestamp has toDate()
        if (x && typeof x.toDate === "function") return x.toDate().toLocaleString();
        // If stored as JS Date in Firestore it returns Timestamp anyway; but handle strings
        if (typeof x === "string") return new Date(x).toLocaleString();
        // If someone stored milliseconds
        if (typeof x === "number") return new Date(x).toLocaleString();
      } catch {}
      return "‚Äî";
    }

    function providerLabel(user) {
      const ids = (user.providerData || []).map(p => p.providerId).filter(Boolean);
      if (!ids.length) return "password";
      // common Firebase IDs: google.com, phone, password
      return ids.join(", ");
    }

    async function getUsernameForUser(user) {
      // 1) Firestore username
      try {
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const data = snap.data();
          if (data.username && String(data.username).trim().length > 0) {
            return data.username.trim();
          }
        }
      } catch {}

      // 2) Google display name
      if (user.displayName && user.displayName.trim().length > 0) return user.displayName.trim();

      // 3) fallback email prefix
      if (user.email) return user.email.split("@")[0];

      return "Account";
    }

    async function loadProfile(user) {
      authPill.textContent = "Signed in";
      authPill.classList.remove("pill-warn");
      authPill.classList.add("pill-ok");

      const username = await getUsernameForUser(user);
      navUsername.textContent = username;

      elUsername.textContent = username || "‚Äî";
      elEmail.textContent = user.email || "‚Äî";
      elPhone.textContent = user.phoneNumber || "‚Äî";
      elProvider.textContent = providerLabel(user) || "‚Äî";
      elUid.textContent = user.uid || "‚Äî";

      // createdAt: prefer Firestore doc if it has it
      let created = null;
      try {
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const data = snap.data();
          created = data.createdAt || null;
        }
      } catch {}

      if (!created && user.metadata && user.metadata.creationTime) {
        created = user.metadata.creationTime;
      }
      elCreated.textContent = formatDateAny(created);
    }

    // ---------- Auth gate ----------
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        authPill.textContent = "Not signed in";
        authPill.classList.remove("pill-ok");
        authPill.classList.add("pill-warn");
        showToast("error", "Sign in required", "Please sign in to view your account.");
        setTimeout(() => (window.location.href = "index.html"), 600);
        return;
      }
      await loadProfile(user);
    });
  </script>
</body>
</html>
