<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Account • PaigonAi</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="account.css" />
</head>

<body>
  <!-- Navbar -->
  <header class="navbar">
    <a href="index.html" class="logo">PaigonAi</a>

    <nav>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="#">Games</a></li>
        <li><a href="#">Leaderboard</a></li>
      </ul>
    </nav>

    <div class="nav-user" id="auth-logged-in">
      <div class="balance-chip" id="balance-chip" title="Wallet (coming soon)">
        <span class="bal-label">Balance</span>
        <span class="bal-amt" id="nav-balance">$0.00</span>
      </div>

      <div class="user-menu">
        <button class="user-button" id="user-button" type="button" aria-haspopup="true" aria-expanded="false">
          <span class="avatar" id="nav-avatar">P</span>
          <span class="user-name" id="nav-username">Account</span>
          <span class="chev">▾</span>
        </button>

        <div class="dropdown is-hidden" id="user-dropdown" role="menu" aria-label="User menu">
          <button class="dropdown-item" id="go-home" type="button" role="menuitem">Home</button>
          <button class="dropdown-item" id="logout" type="button" role="menuitem">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Page -->
  <main class="account-wrap">
    <section class="account-card">
      <div class="account-head">
        <div class="avatar" id="avatar">P</div>
        <div class="account-meta">
          <h1 class="account-title" id="account-title">Account</h1>
          <div class="account-sub" id="account-sub">Loading…</div>
        </div>
      </div>

      <div class="account-grid">
        <div class="panel">
          <h2>Profile</h2>
          <div class="row">
            <div class="label">Username</div>
            <div class="value" id="profile-username">—</div>
          </div>
          <div class="row">
            <div class="label">Email</div>
            <div class="value" id="profile-email">—</div>
          </div>
          <div class="row">
            <div class="label">Provider</div>
            <div class="value" id="profile-provider">—</div>
          </div>
        </div>

        <div class="panel">
          <h2>Wallet</h2>
          <p class="muted">
            Coming soon. This is where balance, deposits, withdrawals, and rewards will live.
          </p>
          <button class="btn btn-primary" id="wallet-soon" type="button">Open Wallet (Soon)</button>
        </div>

        <div class="panel danger">
          <h2>Account Actions</h2>
          <p class="muted">
            For now we’ll only support logout here. Later we can add deletion + settings safely.
          </p>
          <button class="btn btn-ghost" id="logout-2" type="button">Logout</button>
        </div>
      </div>
    </section>
  </main>

  <div id="toast-root" class="toast-root" aria-live="polite" aria-atomic="true"></div>

  <script type="module">
    function showToast(type, title, msg, ms = 2200) {
      const root = document.getElementById("toast-root");
      if (!root) return;
      const el = document.createElement("div");
      el.className = `toast ${type}`;
      el.innerHTML = `<div class="title">${title}</div><div class="msg">${msg}</div>`;
      root.appendChild(el);
      requestAnimationFrame(() => el.classList.add("show"));
      setTimeout(() => {
        el.classList.remove("show");
        setTimeout(() => el.remove(), 250);
      }, ms);
    }

    function formatUSDFromCents(cents) {
      const n = Number(cents || 0) / 100;
      return n.toLocaleString(undefined, { style: "currency", currency: "USD" });
    }

    function avatarLetter(nameOrEmail) {
      const ch = (nameOrEmail || "P").trim()[0]?.toUpperCase() || "P";
      return ch;
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIEYryVjB1gX2bzXWERNI0udfjHXuXwzc",
      authDomain: "paigonco.firebaseapp.com",
      projectId: "paigonco",
      storageBucket: "paigonco.appspot.com",
      messagingSenderId: "879434208536",
      appId: "1:879434208536:web:5ff633fc0534c3f1d73a6d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const navUsername = document.getElementById("nav-username");
    const navAvatar = document.getElementById("nav-avatar");
    const navBalance = document.getElementById("nav-balance");
    const balanceChip = document.getElementById("balance-chip");

    const avatarEl = document.getElementById("avatar");
    const accountTitle = document.getElementById("account-title");
    const accountSub = document.getElementById("account-sub");

    const pUsername = document.getElementById("profile-username");
    const pEmail = document.getElementById("profile-email");
    const pProvider = document.getElementById("profile-provider");

    const userBtn = document.getElementById("user-button");
    const dropdown = document.getElementById("user-dropdown");
    const goHome = document.getElementById("go-home");
    const logoutBtn = document.getElementById("logout");
    const logoutBtn2 = document.getElementById("logout-2");
    const walletSoon = document.getElementById("wallet-soon");

    function forceCloseUserUI() {
      dropdown?.classList.add("is-hidden");
      userBtn?.setAttribute("aria-expanded", "false");
    }

    userBtn?.addEventListener("click", (e) => {
      e.stopPropagation();
      dropdown?.classList.toggle("is-hidden");
      const expanded = dropdown && !dropdown.classList.contains("is-hidden");
      userBtn.setAttribute("aria-expanded", expanded ? "true" : "false");
    });

    document.addEventListener("click", (e) => {
      const wrap = document.querySelector(".user-menu");
      if (!wrap) return;
      if (!wrap.contains(e.target)) forceCloseUserUI();
    });

    goHome?.addEventListener("click", () => window.location.href = "index.html");

    balanceChip?.addEventListener("click", () => {
      showToast("success", "Wallet", "Coming soon.");
      forceCloseUserUI();
    });

    walletSoon?.addEventListener("click", () => showToast("success", "Wallet", "Coming soon."));

    async function doLogout() {
      try {
        await signOut(auth);
        showToast("success", "Signed out", "You’ve been logged out.");
        setTimeout(() => window.location.href = "index.html", 350);
      } catch (err) {
        showToast("error", "Logout failed", err.message);
      }
    }

    logoutBtn?.addEventListener("click", doLogout);
    logoutBtn2?.addEventListener("click", doLogout);

    async function getUserDoc(user) {
      try {
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        if (snap.exists()) return snap.data();
      } catch(e) {}
      return null;
    }

    async function getUsernameForUser(user) {
      const data = await getUserDoc(user);
      if (data?.username && String(data.username).trim()) return String(data.username).trim();
      if (user.displayName && user.displayName.trim()) return user.displayName.trim();
      if (user.email) return user.email.split("@")[0];
      return "Account";
    }

    function providerLabel(user) {
      const p = user.providerData?.[0]?.providerId || "unknown";
      if (p === "password") return "Email/Password";
      if (p === "google.com") return "Google";
      if (p === "phone") return "Phone";
      return p;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      const data = await getUserDoc(user);
      const username = await getUsernameForUser(user);
      const cents = data?.balanceCents ?? 0;

      navUsername.textContent = username;
      navAvatar.textContent = avatarLetter(username);
      navBalance.textContent = formatUSDFromCents(cents);

      accountTitle.textContent = username;
      accountSub.textContent = "Your profile hub (more coming soon).";
      avatarEl.textContent = avatarLetter(username);

      pUsername.textContent = username;
      pEmail.textContent = user.email || "(no email on this account)";
      pProvider.textContent = providerLabel(user);

      forceCloseUserUI();
    });
  </script>
</body>
</html>
